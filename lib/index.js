var y="/components",K=".json",_="index",H0="http://localhost",C="/pages";var B0="shared",I=".ts",J=process.cwd()+"/site",Q0="shared_",$0=process.cwd()+"/templates",V=".template.ts";import{mkdir as d0,readdir as W0}from"node:fs/promises";import{join as h}from"path";async function v(b){if(Array.isArray(b))b=h(...b);return await W0(b)}function q(b,j){return Bun.write(b,j)}function s(b){return Bun.file(b).json()}async function k(b,j){if(Array.isArray(b))b=h(...b);let U=await W0(b,{withFileTypes:!0}),w={data:[],templates:[],styles:[]};for(let B of U){let H=B.name;if(B.isDirectory()){let Q=await k(h(b,H),H);if(w.folders==null)w.folders={};w.folders[H]=Q[H];continue}if(H.endsWith(V)){w.templates.push(H.slice(0,-V.length));continue}if(H.endsWith(K))w.data.push(H.slice(0,-K.length));if(H.endsWith("scss"))w.styles.push(H.slice(0,-K.length))}return{[j??b.split(/[\\/]/).pop()]:w}}function x0(b,j){q(b,JSON.stringify(j,null,2))}async function J0(b){return await Bun.file(b).text()}async function X0(b){await d0(b,{recursive:!1})}function T(b,j){let U={...b};for(let w of Object.keys(j)){let Y=j[w];if(typeof Y==="object"&&Y!==null&&!Array.isArray(Y)){let B=U[w];U[w]=T(typeof B==="object"&&B!==null?B:{},Y)}else U[w]=Y}return U}function _0(b){return b.charAt(0).toUpperCase()+b.slice(1)}function A0(b){return b.charAt(0).toLowerCase()+b.slice(1)}import E from"isomorphic-dompurify";import l from"isomorphic-dompurify";function K0(b){return typeof b==="string"}function P(b){if(K0(b))return l.sanitize(b);if(Array.isArray(b))return b.map((j)=>K0(j)?l.sanitize(j):P(j));if(typeof b==="object"&&b!==null){let j={};for(let[U,w]of Object.entries(b))j[l.sanitize(U)]=P(w);return j}return b}import V0 from"fs";import wb from"path";var p;((b)=>{b.DELETE="DELETE",b.GET="GET",b.OPTIONS="OPTIONS",b.PATCH="PATCH",b.POST="POST",b.PUT="PUT"})(p||={});function m(b){return typeof b==="string"}function O(b){if(m(b))return E.sanitize(b);if(Array.isArray(b))return b.map((j)=>m(j)?E.sanitize(j):O(j));if(typeof b==="object"&&b!==null){let j={};for(let[U,w]of Object.entries(b))j[E.sanitize(U)]=O(w);return j}return b}function Z0(b){return E.sanitize(b)}function t0(b,j=200,U=new Headers){if(j>=300&&j<400)return Response.redirect(b,j);let w={headers:U,status:j};if(b===null)return new Response("",w);if(m(b))return new Response(b,w);return Response.json(b,w)}var R={after:[],before:[]},G0;async function M(b,j,U=t0){let w=a0(b);R.before&&await C0(R.before,w);let Y=await e0(w,j);if(Y.status)w.result.status=Y.status;if(Y.headers){let B=typeof Y.headers.get==="function"?Y.headers.entries():Object.entries(Y.headers);for(let[H,Q]of B)w.result.headers.set(H,Q)}return w.result.body=Y.body??Y,R.after&&await C0(R.after,w),U(w.result.body,w.result.status,w.result.headers)}function v0({after:b,before:j}){if(j)R.before=j;if(b)R.after=b}async function e0(b,{handler:j,inputSchema:U,outputSchema:w}){if(U&&!G0(U,b.body))throw new Error("400|wrong body data");let Y=j.constructor.name==="AsyncFunction"?await j(b):j(b);if(w&&!G0(w,Y))throw new Error("500|result is not as expected");return Y}function a0(b){return{body:bb(b),context:{},headers:b.headers,method:b.method,params:b.params,query:b.url.includes("?")?new URLSearchParams(b.url.split("?")[1]):null,result:{body:null,headers:new Headers},url:b.url}}async function bb(b){if(b.method==="GET"||b.method==="DELETE"||b.method==="OPTIONS"||!b.body)return null;if(!b.json)throw new Error("400|Invalid body");try{let j=await b.json();return P(j)}catch(j){throw new Error(`400|Invalid body
`+(j instanceof Error?j.message:j))}}async function C0(b,j){for(let U of b)await U(j)}var{file:jb}=globalThis.Bun;function R0(b,j){return V0.readdirSync(b).forEach((U)=>{let w=wb.join(b,U);if(V0.statSync(w).isDirectory())j=R0(w,j);else j.push(w)}),j}function Ub(b){try{let j=R0(b,[]),U=b.split("/").pop(),w=j[0].indexOf(U)+U.length;return{content:j.map((Y)=>Y.slice(w)),start:j[0].slice(0,w)}}catch(j){let U="500|";if(!(j instanceof Error))j=new Error(U+j);else j.message=U+j.message;throw j}}function r(b,j){function U(Q){if(Q.endsWith(w))Q=Q.replace(w,"");return j+Q}if(j??=b,j.endsWith("/"))j=j.slice(0,-1);let w="index.html",{content:Y,start:B}=Ub(b),H={};for(let Q of Y)H[U(Q)]=Yb(B+Q);return H}function Yb(b){return()=>new Response(jb(b))}var z=[];async function O0(){if(z.length=0,z=F0(await k(J+C),!0).map((b)=>b.slice(C.length)).map((b)=>b.endsWith(".index")?b.split("/").slice(0,-1).join("/")+"/":b),z[0]==="")z[0]="/"}function N(b,j,U=z){return U.filter((w)=>{let Y=w.split("/").pop();if(!b&&w.endsWith("+"))return!1;if(!j&&Y?.startsWith("_"))return!1;return!0})}function F0(b,j=!1,U=""){let w=[];for(let Y in b){let B=b[Y],H=`${U}/${Y}`.replace(/\/+/g,"/"),Q=B.data.includes(_),$=B.templates.some((x)=>x.endsWith(_)),W=B.templates.some((x)=>x.endsWith("childs"));if(Q&&$)w.push(H);if(W){j&&w.push(`${H}/+`);for(let x of B.data)x!==_&&w.push(`${H}/${x}`)}if(B.folders){let x=F0(B.folders,j,H);w.push(...x)}}return w}import{JSDOM as Ab}from"jsdom";import{join as o}from"path";async function i(b){let j=new URL(H0+b).pathname,U=[J,C],w=j.split("/").slice(1).filter((Q)=>Q!==""),Y=w[w.length-1],B="";for(let Q of w)try{await v([...U,Q]),U.push(Q)}catch($){B=`${U[U.length-1]}.childs`,Y=Q;break}let H=o(...U);if(!B){let Q=w[w.length-1];if(w.length>0&&Y===Q)B+=`${Q}.`,Y=`${Q}.${_}`;else Y=_;B+=_}if(w.length===0)Y=_,B=_;return{templateToLoad:o(H,B+V),dataToLoad:o(H,Y+K)}}import{z as D,ZodDefault as q0,ZodEnum as Hb,ZodOptional as d}from"zod";function k0(b){let j=b._def.shape(),U=Object.keys(j).filter((w)=>{let Y=j[w];return(Y.unwrap?.()??Y)instanceof D.ZodObject});return U.length===0?b.parse({}):b.parse(Object.fromEntries(new Map(U.map((w)=>[w,{}]))))}function t(b){let j=b._def.shape(),U=Object.keys(j).filter((w)=>{let Y=j[w];return(Y.unwrap?.()??Y)instanceof D.ZodObject});return U.length===0?I0(b):Object.fromEntries(new Map(U.map((w)=>[w,I0(j[w])])))}function I0(b){let j=b.shape,U={};for(let w in j){let Y=j[w],B=Y instanceof d,H=Bb(Y._def.description,!1),Q=n(Y),$;if(H)$=B&&!H.endsWith("?")?H+"?":H;else $=B?Q:Q.replace(/\?$/,"");U[w]=$}return U}function n(b){if(b instanceof d)return n(b._def.innerType)+"?";if(b instanceof q0)return n(b._def.innerType);switch(b._def.typeName){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodDate":return"Date";case"ZodEnum":return"enum";default:return"unknown"}}function Bb(b,j){if(!b)return;let{message:U,wrapper:w}=b.startsWith("{")?JSON.parse(b):{message:b,wrapper:null};if(j)return U;return w}function M0(b){let j={},U=b.shape;for(let w in U){let Y=U[w];while(Y instanceof d||Y instanceof q0)Y=Y._def.innerType;if(Y instanceof Hb)j[w]=Y._def.values}return j}import z0 from"isomorphic-dompurify";var g={},Qb=[],$b={addMmsg:a,addPageData:y0,components:g,dataFromPage:T0,render:Jb,sendError:Xb};async function S0(){if(Object.keys(g).length>0)return;let b=J+y,U=(await v(b)).filter((w)=>!w.endsWith(I));for(let w of U)g[w]=await xb(b,w)}function Wb(b,j,U=$b){let{addMmsg:w,addPageData:Y,components:B,dataFromPage:H,render:Q,sendError:$}=U,W=f0(),{description:x,schema:X,template:F}=B[b],A=H(b,j);if(X===void 0&&F===void 0)return $(`Component ${b} not found or has no schema or template`);if(X===void 0&&!u(A)&&F.length>0)return $(`Schema not found for component ${b}, and no data found${j!==void 0?" for "+j:""} in pageData`);if(X!==null&&u(A)){let Z=X.safeParse(A);if(!Z.success)return $("Error in "+b+(j!==void 0?"."+j:"")+": "+Z.error.message)}if(X!==null&&!u(A))A=k0(X),w("default values used for "+b+(j!==void 0?"."+j:""));if(W){if(u(A)&&Y(b,j,A),X!==null&&X!==void 0){let Z=t(X);e(b,Z),["enum","enum?"].some((f)=>Object.values(Z).includes(f))&&e("_enum."+b,M0(X))}}return Q({data:A,editorMode:W,pageSettings:P0(),template:F,component:b,id:j})}async function xb(b,j,U=Qb,w=I){let{description:Y,isSingle:B,schema:H,template:Q}=await import(`${b}/${j}/${j}${w}`);return B===!0&&U.push(j),{description:Y,schema:H,template:Q}}function Jb({data:b,editorMode:j,pageSettings:U,component:w,id:Y,template:B}){let H=B({[w]:b,pageSettings:U});if(j)return Y!==void 0?H.replace(/data-editor="(.*?)"/g,(W,x)=>{return`data-editor="${x}.${Y}"`}):H;if(!H.includes("data-editor"))return H;let Q=z0.sanitize(H,{RETURN_DOM_FRAGMENT:!0});for(let $ of Array.from(Q.querySelectorAll("[data-editor]")))$.setAttribute("data-editor",$.getAttribute("data-editor").replace(/-[^-]+$/,""));return z0.sanitize(H)}function Xb(b){return a(b),""}function _b(b){return JSON.stringify(b)}function u(b){if(!b||b===void 0)return!1;if(Object.keys(b).length>0)return!0;return!1}function L0(){return t(g.pageSettings.schema)}var L=[],b0={},E0=!1,G={},S={};async function N0(b,j){L.length=0,await S0();let{templateToLoad:U,dataToLoad:w}=await i(b);try{let{template:Y}=await import(U);G=await g0(w);let B=await u0();for(let[H,Q]of Object.entries(B))G[H]={...G[H]??{},...Q};return j?Kb(Y):D0(Y())}catch(Y){console.log("Error",Y)}}function D0(b){if(typeof b!=="string")return b;return b.replace(/\n+/g," ").replace(/\s{2,}/g," ").replace(/>\s+</g,"><").trim()}function Kb(b){E0=!0,b0={pageSettings:L0()},S.pageSettings=G.pageSettings;let j=b(),U=`
  <script src="https://cdn.tiny.cloud/1/2twbfyfjocws7ln2yp1xbioznajuwpd2obek1kwsiev66noc/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

  <script src="/_editor/interface.js" defer></script>
  <script>
    var editorData = ${JSON.stringify(b0)}
    var pageData   = ${JSON.stringify(S)}
    var messages   = ${JSON.stringify(L)}
  </script>
  <link href="/_editor/style.css" rel="stylesheet" />`;return j.replace(/<head>/,`<head>${U}`)}function a(b){L.push(b)}function f0(){return E0}function e(b,j){b0[b]=j}function y0(b,j,U){if(S[b]??={},j!==void 0)S[b][j]=U;else S[b]=U}async function u0(){return await s(J+"/"+B0+K)}async function g0(b){return await s(b)}function T0(b,j){return j!==void 0?G[b]?.[j]:G[b]}function P0(){return G.pageSettings}async function c0({component:b,data:j,editorData:U,id:w,url:Y}){function B(){if(b===U)return{[b]:O(j)};let[Z,f,Y0]=U.split(".");return Y0===void 0?{[b]:{[f]:O(j)}}:{[b]:{[Y0]:{[f]:O(j)}}}}let{dataToLoad:H,templateToLoad:Q}=await i(Y),$=w&&w.startsWith(Q0),W=$?await u0():await g0(H),x=T(W,B());if(!$)x.pageSettings.modificationDate=new Date().toISOString();await x0(H,x),G=T(G,x),L.length=0;let{template:X}=await import(Q),F=await X(),A=new Ab(F).window.document;return{content:D0(A.querySelector("body").innerHTML),pageData:G,messages:L}}var h0={...r(J+"/public","/"),...r(__dirname+"/adminInterface","/_editor")};async function s0(b){return await M(b,{handler:async(j)=>{let U=new URL(j.url).pathname;if(!N(!1,!1).includes(U))throw new Error("404|page "+U+" not found");return{status:200,body:await N0(Z0(U),!0),headers:{"Content-Type":"text/html"}}}})}var l0="/api/v1",m0={[l0+"/update-partial"]:{[p.POST]:(b)=>M(b,{handler:async(j)=>{return{body:await c0(await j.body),status:200}}})},[l0+"/siteTree"]:(b)=>M(b,{handler:async()=>{return{body:await N(!1,!0),status:200}}})};var p0={},Gb={error(b){let[j,U]=b.message.includes("|")?b.message.split("|"):["500",b.message];return console.error(b.message,{status:j,msg:U},b.stack),new Response(U??b.message,{headers:{"Content-Type":"text/html"},status:parseInt(j)})},fetch:async(b)=>{return await s0(b)},websocket:{message(){p0.publish("connection","connected")}},port:4001,routes:{...m0,...h0}};function r0(){p0=Bun.serve(Gb)}v0({after:[async(b)=>{b.result.headers.set("Cache-Control","no-cache")}]});var c;((j)=>j.CHANGE="change")(c||={});var j0;((j)=>j.SCSS="scss")(j0||={});var w0;((U)=>{U.COMPONENTS="components";U.PAGES="pages"})(w0||={});import*as o0 from"sass";async function U0(b=!1){let j={charset:!0,sourceMap:!b,loadPaths:[J+"/css"]};if(b)j.style="compressed";let U=await o0.compileAsync(J+"/css/style.scss",j);q(J+"/public/style.css",U.css.toString()),console.log("css generated")}import{watch as Cb}from"chokidar";function i0(b,j,U,w){let Y=Cb(b,{persistent:!0});function B($){for(let W of j)if($.endsWith(W))return W;return null}function H($){for(let W of U)if($.includes(W)&&!$.endsWith(W))return W;return null}function Q($,W){return B(W)}for(let $ of Object.values(c))Y.on($,(W)=>{let x=Q($,W);x!==null&&w[$][x]()})}function n0(){i0([process.cwd()+"/site"],Object.values(j0),Object.values(w0),{change:{scss:U0}})}async function fj(){r0(),await O0(),n0()}var yj={firstLetterLowerCase:A0,firstLetterUppercase:_0,createDirectory:X0,getFolderContent:v,getFolderContentRecursive:k,readFileAsString:J0,writeToFile:q},Tj={componentFolder:y,dataExtension:K,index:_,pageFolder:C,projectRoot:J,templateExtension:V,templateFolder:$0,tsExtension:I};export{yj as utils,Wb as useComponent,fj as startYajsb,U0 as makeCss,_b as describeComponent,Tj as constants};
