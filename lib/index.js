var P="/components",C=".json",K="index",$0="http://localhost",x="/pages";var h="shared",M=".ts",G=process.cwd()+"/site",w0="shared_",W0=process.cwd()+"/templates",R=".template.ts";import{mkdir as d0,readdir as X0}from"node:fs/promises";import{join as l}from"path";async function F(Y){if(Array.isArray(Y))Y=l(...Y);return await X0(Y)}function z(Y,H){return Bun.write(Y,H)}function f(Y){return Bun.file(Y).json()}async function k(Y,H){if(Array.isArray(Y))Y=l(...Y);let Q=await X0(Y,{withFileTypes:!0}),B={data:[],templates:[],styles:[]};for(let W of Q){let w=W.name;if(W.isDirectory()){let X=await k(l(Y,w),w);if(B.folders==null)B.folders={};B.folders[w]=X[w];continue}if(w.endsWith(R)){B.templates.push(w.slice(0,-R.length));continue}if(w.endsWith(C))B.data.push(w.slice(0,-C.length));if(w.endsWith("scss"))B.styles.push(w.slice(0,-C.length))}return{[H??Y.split(/[\\/]/).pop()]:B}}function _0(Y,H){z(Y,JSON.stringify(H,null,2))}async function J0(Y){return await Bun.file(Y).text()}async function U0(Y){await d0(Y,{recursive:!1})}function G0(Y){return Y.charAt(0).toUpperCase()+Y.slice(1)}function K0(Y){return Y.charAt(0).toLowerCase()+Y.slice(1)}import y from"isomorphic-dompurify";import m from"isomorphic-dompurify";function C0(Y){return typeof Y==="string"}function E(Y){if(C0(Y))return m.sanitize(Y);if(Array.isArray(Y))return Y.map((H)=>C0(H)?m.sanitize(H):E(H));if(typeof Y==="object"&&Y!==null){let H={};for(let[Q,B]of Object.entries(Y))H[m.sanitize(Q)]=E(B);return H}return Y}import Z0 from"fs";import HY from"path";var p;((Y)=>{Y.DELETE="DELETE",Y.GET="GET",Y.OPTIONS="OPTIONS",Y.PATCH="PATCH",Y.POST="POST",Y.PUT="PUT"})(p||={});function s(Y){return typeof Y==="string"}function q(Y){if(s(Y))return y.sanitize(Y);if(Array.isArray(Y))return Y.map((H)=>s(H)?y.sanitize(H):q(H));if(typeof Y==="object"&&Y!==null){let H={};for(let[Q,B]of Object.entries(Y))H[y.sanitize(Q)]=q(B);return H}return Y}function x0(Y){return y.sanitize(Y)}function o0(Y,H=200,Q=new Headers){if(H>=300&&H<400)return Response.redirect(Y,H);let B={headers:Q,status:H};if(Y===null)return new Response("",B);if(s(Y))return new Response(Y,B);return Response.json(Y,B)}var I={after:[],before:[]},A0;async function L(Y,H,Q=o0){let B=a0(Y);I.before&&await V0(I.before,B);let $=await t0(B,H);if($.status)B.result.status=$.status;if($.headers){let W=typeof $.headers.get==="function"?$.headers.entries():Object.entries($.headers);for(let[w,X]of W)B.result.headers.set(w,X)}return B.result.body=$.body??$,I.after&&await V0(I.after,B),Q(B.result.body,B.result.status,B.result.headers)}function R0({after:Y,before:H}){if(H)I.before=H;if(Y)I.after=Y}async function t0(Y,{handler:H,inputSchema:Q,outputSchema:B}){if(Q&&!A0(Q,Y.body))throw new Error("400|wrong body data");let $=H.constructor.name==="AsyncFunction"?await H(Y):H(Y);if(B&&!A0(B,$))throw new Error("500|result is not as expected");return $}function a0(Y){return{body:e0(Y),context:{},headers:Y.headers,method:Y.method,params:Y.params,query:Y.url.includes("?")?new URLSearchParams(Y.url.split("?")[1]):null,result:{body:null,headers:new Headers},url:Y.url}}async function e0(Y){if(Y.method==="GET"||Y.method==="DELETE"||Y.method==="OPTIONS"||!Y.body)return null;if(!Y.json)throw new Error("400|Invalid body");try{let H=await Y.json();return E(H)}catch(H){throw new Error(`400|Invalid body
`+(H instanceof Error?H.message:H))}}async function V0(Y,H){for(let Q of Y)await Q(H)}var{file:YY}=globalThis.Bun;function O0(Y,H){return Z0.readdirSync(Y).forEach((Q)=>{let B=HY.join(Y,Q);if(Z0.statSync(B).isDirectory())H=O0(B,H);else H.push(B)}),H}function BY(Y){try{let H=O0(Y,[]),Q=Y.split("/").pop(),B=H[0].indexOf(Q)+Q.length;return{content:H.map(($)=>$.slice(B)),start:H[0].slice(0,B)}}catch(H){let Q="500|";if(!(H instanceof Error))H=new Error(Q+H);else H.message=Q+H.message;throw H}}function r(Y,H){function Q(X){if(X.endsWith(B))X=X.replace(B,"");return H+X}if(H??=Y,H.endsWith("/"))H=H.slice(0,-1);let B="index.html",{content:$,start:W}=BY(Y),w={};for(let X of $)w[Q(X)]=QY(W+X);return w}function QY(Y){return()=>new Response(YY(Y))}var v=[];async function F0(){if(v.length=0,v=I0(await k(G+x),!0).map((Y)=>Y.slice(x.length)).map((Y)=>Y.endsWith(".index")?Y.split("/").slice(0,-1).join("/")+"/":Y),v[0]==="")v[0]="/"}function N(Y,H,Q=v){return Q.filter((B)=>{let $=B.split("/").pop();if(!Y&&B.endsWith("+"))return!1;if(!H&&$?.startsWith("_"))return!1;return!0})}function I0(Y,H=!1,Q=""){let B=[];for(let $ in Y){let W=Y[$],w=`${Q}/${$}`.replace(/\/+/g,"/"),X=W.data.includes(K),_=W.templates.some((J)=>J.endsWith(K)),U=W.templates.some((J)=>J.endsWith("childs"));if(X&&_)B.push(w);if(U){H&&B.push(`${w}/+`);for(let J of W.data)J!==K&&B.push(`${w}/${J}`)}if(W.folders){let J=I0(W.folders,H,w);B.push(...J)}}return B}async function q0(){return await f(G+"/"+h+C)}async function T(Y){return await f(Y)}async function M0(Y,H,Q,B){let[$,W,w]=B.split("."),X=W&&W.startsWith(w0)?!0:!1,_=X?G+"/"+h+C:Y;return{target:_,dataToSave:j(await f(_),$Y(Q,w,W,H)),isSharedData:X}}function j(Y,H){let Q={...Y};for(let B of Object.keys(H)){let $=H[B];if(typeof $==="object"&&$!==null&&!Array.isArray($)){let W=Q[B];Q[B]=j(typeof W==="object"&&W!==null?W:{},$)}else Q[B]=$}return Q}function $Y(Y,H,Q,B){if(Q===void 0&&H===void 0)return{[Y]:q(B)};return H===void 0?{[Y]:{[Q]:q(B)}}:{[Y]:{[H]:{[Q]:q(B)}}}}import{z as D,ZodDefault as k0,ZodEnum as wY,ZodOptional as n}from"zod";function L0(Y){let H=Y._def.shape(),Q=Object.keys(H).filter((B)=>{let $=H[B];return($.unwrap?.()??$)instanceof D.ZodObject});return Q.length===0?Y.parse({}):Y.parse(Object.fromEntries(new Map(Q.map((B)=>[B,{}]))))}function d(Y){let H=Y._def.shape(),Q=Object.keys(H).filter((B)=>{let $=H[B];return($.unwrap?.()??$)instanceof D.ZodObject});return Q.length===0?z0(Y):Object.fromEntries(new Map(Q.map((B)=>[B,z0(H[B])])))}function z0(Y){let H=Y.shape,Q={};for(let B in H){let $=H[B],W=$ instanceof n,w=WY($._def.description,!1),X=i($),_;if(w)_=W&&!w.endsWith("?")?w+"?":w;else _=W?X:X.replace(/\?$/,"");Q[B]=_}return Q}function i(Y){if(Y instanceof n)return i(Y._def.innerType)+"?";if(Y instanceof k0)return i(Y._def.innerType);switch(Y._def.typeName){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodDate":return"Date";case"ZodEnum":return"enum";default:return"unknown"}}function WY(Y,H){if(!Y)return;let{message:Q,wrapper:B}=Y.startsWith("{")?JSON.parse(Y):{message:Y,wrapper:null};if(H)return Q;return B}function v0(Y){let H={},Q=Y.shape;for(let B in Q){let $=Q[B];while($ instanceof n||$ instanceof k0)$=$._def.innerType;if($ instanceof wY)H[B]=$._def.values}return H}import j0 from"isomorphic-dompurify";var g={},XY=[],_Y={addMmsg:t,addPageData:f0,components:g,dataFromPage:E0,render:GY,sendError:KY};async function S0(){if(Object.keys(g).length>0)return;let Y=G+P,Q=(await F(Y)).filter((B)=>!B.endsWith(M));for(let B of Q)g[B]=await UY(Y,B)}function JY(Y,H,Q=_Y){let{addMmsg:B,addPageData:$,components:W,dataFromPage:w,render:X,sendError:_}=Q,U=P0(),{schema:J,template:V}=W[Y],A=w(Y,H);if(J===void 0&&V===void 0)return _(`Component ${Y} not found or has no schema or template`);if(J===void 0&&!u(A)&&V.length>0)return _(`Schema not found for component ${Y}, and no data found${H!==void 0?" for "+H:""} in pageData`);if(J!==null&&u(A)){let Z=J.safeParse(A);if(!Z.success)return _("Error in "+Y+(H!==void 0?"."+H:"")+": "+Z.error.message)}if(J!==null&&!u(A))A=L0(J),B("default values used for "+Y+(H!==void 0?"."+H:""));if(U){if(u(A)&&$(Y,H,A),J!==null&&J!==void 0){let Z=d(J);o(Y,Z),["enum","enum?"].some((n0)=>Object.values(Z).includes(n0))&&o("_enum."+Y,v0(J))}}return X({data:A,editorMode:U,pageSettings:y0(),template:V,component:Y,id:H})}async function UY(Y,H,Q=XY,B=M){let{description:$,isSingle:W,schema:w,template:X}=await import(`${Y}/${H}/${H}${B}`);return W===!0&&Q.push(H),{description:$,schema:w,template:X}}function GY({data:Y,editorMode:H,pageSettings:Q,component:B,id:$,template:W}){let w=W({[B]:Y,pageSettings:Q});if(H){let _=new RegExp(`data-editor="${B}(.*?)"`,"g");return $!==void 0?w.replace(_,(J,V)=>{return`data-editor="${B}${V}.${$}"`}):w}if(!w.includes("data-editor"))return w;let X=j0.sanitize(w,{RETURN_DOM_FRAGMENT:!0});for(let _ of Array.from(X.querySelectorAll("[data-editor]")))_.setAttribute("data-editor",_.getAttribute("data-editor").replace(/-[^-]+$/,""));return j0.sanitize(w)}function KY(Y){return t(Y),""}function CY(Y){return JSON.stringify(Y)}function u(Y){if(!Y||Y===void 0)return!1;if(Object.keys(Y).length>0)return!0;return!1}function b0(){return d(g.pageSettings.schema)}import{JSDOM as AY}from"jsdom";import{join as a}from"path";async function e(Y){let H=new URL($0+Y).pathname,Q=[G,x],B=H.split("/").slice(1).filter((X)=>X!==""),$=B[B.length-1],W="";for(let X of B)try{await F([...Q,X]),Q.push(X)}catch(_){W=`${Q[Q.length-1]}.childs`,$=X;break}let w=a(...Q);if(!W){let X=B[B.length-1];if(B.length>0&&$===X)W+=`${X}.`,$=`${X}.${K}`;else $=K;W+=K}if(B.length===0)$=K,W=K;return{templateToLoad:a(w,W+R),dataToLoad:a(w,$+C)}}var b=[],Y0={},N0=!1,O={},S={};async function T0(Y,H){b.length=0,await S0();let{templateToLoad:Q,dataToLoad:B}=await e(Y);try{let{template:$}=await import(Q);return O=j(await T(B),await q0()),H?VY($):D0($())}catch($){console.log("Error",$)}}function D0(Y){if(typeof Y!=="string")return Y;return Y.replace(/\n+/g," ").replace(/\s{2,}/g," ").replace(/>\s+</g,"><").trim()}function VY(Y){N0=!0,Y0={pageSettings:b0()},S.pageSettings=O.pageSettings;let H=Y(),Q=`
  <script src="https://cdn.tiny.cloud/1/2twbfyfjocws7ln2yp1xbioznajuwpd2obek1kwsiev66noc/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

  <script src="/_editor/interface.js" defer></script>
  <script>
    var editorData = ${JSON.stringify(Y0)}
    var pageData   = ${JSON.stringify(S)}
    var messages   = ${JSON.stringify(b)}
  </script>
  <link href="/_editor/style.css" rel="stylesheet" />`;return H.replace(/<head>/,`<head>${Q}`)}function t(Y){b.push(Y)}function P0(){return N0}function o(Y,H){Y0[Y]=H}function f0(Y,H,Q){if(S[Y]??={},H!==void 0)S[Y][H]=Q;else S[Y]=Q}function E0(Y,H){return H!==void 0?O[Y]?.[H]:O[Y]}function y0(){return O.pageSettings}async function u0({component:Y,data:H,editorData:Q,url:B}){let{templateToLoad:$,dataToLoad:W}=await e(B),{dataToSave:w,isSharedData:X,target:_}=await M0(W,H,Y,Q);await _0(_,w),b.length=0;let U=X?w:await T(_),J=X?await T(W):w;O=j(J,U);let{template:V}=await import($),A=await V(),Z=new AY(A).window.document;return{content:D0(Z.querySelector("body").innerHTML),pageData:O,messages:b}}var g0={...r(G+"/public","/"),...r(__dirname+"/adminInterface","/_editor")};async function c0(Y){return await L(Y,{handler:async(H)=>{let Q=new URL(H.url).pathname;if(!N(!1,!1).includes(Q))throw new Error("404|page "+Q+" not found");return{status:200,body:await T0(x0(Q),!0),headers:{"Content-Type":"text/html"}}}})}var h0="/api/v1",l0={[h0+"/update-partial"]:{[p.POST]:(Y)=>L(Y,{handler:async(H)=>{return{body:await u0(await H.body),status:200}}})},[h0+"/siteTree"]:(Y)=>L(Y,{handler:async()=>{return{body:await N(!1,!0),status:200}}})};var m0={},ZY={error(Y){let[H,Q]=Y.message.includes("|")?Y.message.split("|"):["500",Y.message];return console.error(Y.message,{status:H,msg:Q},Y.stack),new Response(Q??Y.message,{headers:{"Content-Type":"text/html"},status:parseInt(H)})},fetch:async(Y)=>{return await c0(Y)},websocket:{message(){m0.publish("connection","connected")}},port:4001,routes:{...l0,...g0}};function s0(){m0=Bun.serve(ZY)}R0({after:[async(Y)=>{Y.result.headers.set("Cache-Control","no-cache")}]});var c;((H)=>H.CHANGE="change")(c||={});var H0;((H)=>H.SCSS="scss")(H0||={});var B0;((Q)=>{Q.COMPONENTS="components";Q.PAGES="pages"})(B0||={});import*as p0 from"sass";async function Q0(Y=!1){let H={charset:!0,sourceMap:!Y,loadPaths:[G+"/css"]};if(Y)H.style="compressed";let Q=await p0.compileAsync(G+"/css/style.scss",H);z(G+"/public/style.css",Q.css.toString()),console.log("css generated")}import{watch as xY}from"chokidar";function r0(Y,H,Q,B){let $=xY(Y,{persistent:!0});function W(_){for(let U of H)if(_.endsWith(U))return U;return null}function w(_){for(let U of Q)if(_.includes(U)&&!_.endsWith(U))return U;return null}function X(_,U){return W(U)}for(let _ of Object.values(c))$.on(_,(U)=>{let J=X(_,U);J!==null&&B[_][J]()})}function i0(){r0([process.cwd()+"/site"],Object.values(H0),Object.values(B0),{change:{scss:Q0}})}async function EH(){s0(),await F0(),i0()}var yH={firstLetterLowerCase:K0,firstLetterUppercase:G0,createDirectory:U0,getFolderContent:F,getFolderContentRecursive:k,readFileAsString:J0,writeToFile:z},NH={componentFolder:P,dataExtension:C,index:K,pageFolder:x,projectRoot:G,templateExtension:R,templateFolder:W0,tsExtension:M};export{yH as utils,JY as useComponent,EH as startYajsb,Q0 as makeCss,CY as describeComponent,NH as constants};
