var v="/components",O=".json",Z="index",$0="http://localhost",M="/pages";var c="shared",b=".ts",U=process.cwd()+"/site",B0="shared_",X0=process.cwd()+"/templates",q=".template.ts";import{mkdir as n0,readdir as _0}from"node:fs/promises";import{join as l}from"path";async function w(H){if(Array.isArray(H))H=l(...H);return await _0(H)}function x(H,Q){return Bun.write(H,Q)}function P(H){return Bun.file(H).json()}async function F(H,Q){if(Array.isArray(H))H=l(...H);let $=await _0(H,{withFileTypes:!0}),Y={data:[],templates:[],styles:[]};for(let _ of $){let X=_.name;if(_.isDirectory()){let J=await F(l(H,X),X);if(Y.folders==null)Y.folders={};Y.folders[X]=J[X];continue}if(X.endsWith(q)){Y.templates.push(X.slice(0,-q.length));continue}if(X.endsWith(O))Y.data.push(X.slice(0,-O.length));if(X.endsWith("scss"))Y.styles.push(X.slice(0,-O.length))}return{[Q??H.split(/[\\/]/).pop()]:Y}}function J0(H,Q){x(H,JSON.stringify(Q,null,2))}async function W0(H){return await Bun.file(H).text()}async function G0(H){await n0(H,{recursive:!1})}function K0(H){return H.charAt(0).toUpperCase()+H.slice(1)}function U0(H){return H.charAt(0).toLowerCase()+H.slice(1)}import E from"isomorphic-dompurify";import h from"isomorphic-dompurify";function V0(H){return typeof H==="string"}function N(H){if(V0(H))return h.sanitize(H);if(Array.isArray(H))return H.map((Q)=>V0(Q)?h.sanitize(Q):N(Q));if(typeof H==="object"&&H!==null){let Q={};for(let[$,Y]of Object.entries(H))Q[h.sanitize($)]=N(Y);return Q}return H}import A0 from"fs";import HH from"path";var p;((H)=>{H.DELETE="DELETE",H.GET="GET",H.OPTIONS="OPTIONS",H.PATCH="PATCH",H.POST="POST",H.PUT="PUT"})(p||={});function m(H){return typeof H==="string"}function j(H){if(m(H))return E.sanitize(H);if(Array.isArray(H))return H.map((Q)=>m(Q)?E.sanitize(Q):j(Q));if(typeof H==="object"&&H!==null){let Q={};for(let[$,Y]of Object.entries(H))Q[E.sanitize($)]=j(Y);return Q}return H}function M0(H){return E.sanitize(H)}function r0(H,Q=200,$=new Headers){if(Q>=300&&Q<400)return Response.redirect(H,Q);let Y={headers:$,status:Q};if(H===null)return new Response("",Y);if(m(H))return new Response(H,Y);return Response.json(H,Y)}var z={after:[],before:[]},Z0;async function R(H,Q,$=r0){let Y=a0(H);z.before&&await O0(z.before,Y);let B=await o0(Y,Q);if(B.status)Y.result.status=B.status;if(B.headers){let _=typeof B.headers.get==="function"?B.headers.entries():Object.entries(B.headers);for(let[X,J]of _)Y.result.headers.set(X,J)}return Y.result.body=B.body??B,z.after&&await O0(z.after,Y),$(Y.result.body,Y.result.status,Y.result.headers)}function q0({after:H,before:Q}){if(Q)z.before=Q;if(H)z.after=H}async function o0(H,{handler:Q,inputSchema:$,outputSchema:Y}){if($&&!Z0($,H.body))throw new Error("400|wrong body data");let B=Q.constructor.name==="AsyncFunction"?await Q(H):Q(H);if(Y&&!Z0(Y,B))throw new Error("500|result is not as expected");return B}function a0(H){return{body:t0(H),context:{},headers:H.headers,method:H.method,params:H.params,query:H.url.includes("?")?new URLSearchParams(H.url.split("?")[1]):null,result:{body:null,headers:new Headers},url:H.url}}async function t0(H){if(H.method==="GET"||H.method==="DELETE"||H.method==="OPTIONS"||!H.body)return null;if(!H.json)throw new Error("400|Invalid body");try{let Q=await H.json();return N(Q)}catch(Q){throw new Error(`400|Invalid body
`+(Q instanceof Error?Q.message:Q))}}async function O0(H,Q){for(let $ of H)await $(Q)}var{file:e0}=globalThis.Bun;function C0(H,Q){return A0.readdirSync(H).forEach(($)=>{let Y=HH.join(H,$);if(A0.statSync(Y).isDirectory())Q=C0(Y,Q);else Q.push(Y)}),Q}function QH(H){try{let Q=C0(H,[]),$=H.split("/").pop(),Y=Q[0].indexOf($)+$.length;return{content:Q.map((B)=>B.slice(Y)),start:Q[0].slice(0,Y)}}catch(Q){let $="500|";if(!(Q instanceof Error))Q=new Error($+Q);else Q.message=$+Q.message;throw Q}}function s(H,Q){function $(J){if(J.endsWith(Y))J=J.replace(Y,"");return Q+J}if(Q??=H,Q.endsWith("/"))Q=Q.slice(0,-1);let Y="index.html",{content:B,start:_}=QH(H),X={};for(let J of B)X[$(J)]=YH(_+J);return X}function YH(H){return()=>new Response(e0(H))}var S=[];async function I0(){if(S.length=0,S=w0(await F(U+M),!0).map((H)=>H.slice(M.length)).map((H)=>H.endsWith(".index")?H.split("/").slice(0,-1).join("/")+"/":H),S[0]==="")S[0]="/"}function D(H,Q,$=S){return $.filter((Y)=>{let B=Y.split("/").pop();if(!H&&Y.endsWith("+"))return!1;if(!Q&&B?.startsWith("_"))return!1;return!0})}function w0(H,Q=!1,$=""){let Y=[];for(let B in H){let _=H[B],X=`${$}/${B}`.replace(/\/+/g,"/"),J=_.data.includes(Z),W=_.templates.some((K)=>K.endsWith(Z)),G=_.templates.some((K)=>K.endsWith("childs"));if(J&&W)Y.push(X);if(G){Q&&Y.push(`${X}/+`);for(let K of _.data)K!==Z&&Y.push(`${X}/${K}`)}if(_.folders){let K=w0(_.folders,Q,X);Y.push(...K)}}return Y}async function z0(){return await P(U+"/"+c+O)}async function T(H){return await P(H)}async function j0(H,Q,$,Y){let[B,_,X]=Y.split("."),J=_&&_.startsWith(B0)?!0:!1,W=J?U+"/"+c+O:H;return{target:W,dataToSave:C(await P(W),$H($,X,_,Q)),isSharedData:J}}function C(H,Q){let $={...H};for(let Y of Object.keys(Q)){let B=Q[Y];if(typeof B==="object"&&B!==null&&!Array.isArray(B)){let _=$[Y];$[Y]=C(typeof _==="object"&&_!==null?_:{},B)}else $[Y]=B}return $}function $H(H,Q,$,Y){if($===void 0&&Q===void 0)return{[H]:j(Y)};return Q===void 0?{[H]:{[$]:j(Y)}}:{[H]:{[Q]:{[$]:j(Y)}}}}import{z as y,ZodDefault as x0,ZodEnum as BH,ZodOptional as i}from"zod";function F0(H){let Q=H._def.shape(),$=Object.keys(Q).filter((Y)=>{let B=Q[Y];return(B.unwrap?.()??B)instanceof y.ZodObject});return $.length===0?H.parse({}):H.parse(Object.fromEntries(new Map($.map((Y)=>[Y,{}]))))}function n(H){let Q=H._def.shape(),$=Object.keys(Q).filter((Y)=>{let B=Q[Y];return(B.unwrap?.()??B)instanceof y.ZodObject});return $.length===0?b0(H):Object.fromEntries(new Map($.map((Y)=>[Y,b0(Q[Y])])))}function b0(H){let Q=H.shape,$={};for(let Y in Q){let B=Q[Y],_=B instanceof i,X=XH(B._def.description,!1),J=d(B),W;if(X)W=_&&!X.endsWith("?")?X+"?":X;else W=_?J:J.replace(/\?$/,"");$[Y]=W}return $}function d(H){if(H instanceof i)return d(H._def.innerType)+"?";if(H instanceof x0)return d(H._def.innerType);switch(H._def.typeName){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodDate":return"Date";case"ZodEnum":return"enum";default:return"unknown"}}function XH(H,Q){if(!H)return;let{message:$,wrapper:Y}=H.startsWith("{")?JSON.parse(H):{message:H,wrapper:null};if(Q)return $;return Y}function R0(H){let Q={},$=H.shape;for(let Y in $){let B=$[Y];while(B instanceof i||B instanceof x0)B=B._def.innerType;if(B instanceof BH)Q[Y]=B._def.values}return Q}import S0 from"isomorphic-dompurify";var f={},_H=[],JH={addPageData:N0,components:f,dataFromPage:E0,render:KH,sendError:UH};async function k0(){if(Object.keys(f).length>0)return;let H=U+v,$=(await w(H)).filter((Y)=>!Y.endsWith(b));for(let Y of $)f[Y]=await GH(H,Y)}function WH(H,Q,$=JH){let{addPageData:Y,components:B,dataFromPage:_,render:X,sendError:J}=$,W=P0(),{schema:G,template:K}=B[H],V=_(H,Q);if(G===void 0&&K===void 0)return J(`Component ${H} not found or has no schema or template`);if(G===void 0&&!r(V)&&K.length>0)return J(`Schema not found for component ${H}, and no data found${Q!==void 0?" for "+Q:""} in pageData`);if(V=G!==null?C(F0(G),V??{}):V,G!==null&&r(V)){let A=G.safeParse(V);if(!A.success)return J("Error in "+H+(Q!==void 0?"."+Q:"")+": "+A.error.message)}if(W){if(r(V)&&Y(H,Q,V),G!==null&&G!==void 0){let A=n(G);o(H,A),["enum","enum?"].some((g)=>Object.values(A).includes(g))&&o("_enum."+H,R0(G))}}return X({data:V,editorMode:W,pageSettings:D0(),template:K,component:H,id:Q})}async function GH(H,Q,$=_H,Y=b){let{description:B,isSingle:_,schema:X,template:J}=await import(`${H}/${Q}/${Q}${Y}`);return _===!0&&$.push(Q),{description:B,schema:X,template:J}}function KH({data:H,editorMode:Q,pageSettings:$,component:Y,id:B,template:_}){let X=_({[Y]:H,pageSettings:$});if(Q){let W=new RegExp(`data-editor="${Y}(.*?)"`,"g");return B!==void 0?X.replace(W,(K,V)=>{return`data-editor="${Y}${V}.${B}"`}):X}if(!X.includes("data-editor"))return X;let J=S0.sanitize(X,{RETURN_DOM_FRAGMENT:!0});for(let W of Array.from(J.querySelectorAll("[data-editor]")))W.setAttribute("data-editor",W.getAttribute("data-editor").replace(/-[^-]+$/,""));return S0.sanitize(X)}function UH(H){return v0(H),""}function VH(H){return JSON.stringify(H)}function r(H){if(!H||H===void 0)return!1;if(Object.keys(H).length>0)return!0;return!1}function L0(){return n(f.pageSettings.schema)}import{JSDOM as ZH}from"jsdom";import{join as a}from"path";async function t(H){let Q=new URL($0+H).pathname,$=[U,M],Y=Q.split("/").slice(1).filter((J)=>J!==""),B=Y[Y.length-1],_="";for(let J of Y)try{await w([...$,J]),$.push(J)}catch(W){_=`${$[$.length-1]}.childs`,B=J;break}let X=a(...$);if(!_){let J=Y[Y.length-1];if(Y.length>0&&B===J)_+=`${J}.`,B=`${J}.${Z}`;else B=Z;_+=Z}if(Y.length===0)B=Z,_=Z;return{templateToLoad:a(X,_+q),dataToLoad:a(X,B+O)}}var L=[],e={},T0=!1,I={},k={};async function y0(H,Q){L.length=0,await k0();let{templateToLoad:$,dataToLoad:Y}=await t(H);try{let{template:B}=await import($);return I=C(await T(Y),await z0()),Q?OH(B):f0(B())}catch(B){console.log("Error",B)}}function f0(H){if(typeof H!=="string")return H;return H.replace(/\n+/g," ").replace(/\s{2,}/g," ").replace(/>\s+</g,"><").trim()}function OH(H){T0=!0,e={pageSettings:L0()},k.pageSettings=I.pageSettings;let Q=H(),$=`
  <script src="https://cdn.tiny.cloud/1/2twbfyfjocws7ln2yp1xbioznajuwpd2obek1kwsiev66noc/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

  <script src="/_editor/interface.js" defer></script>
  <script>
    var editorData = ${JSON.stringify(e)}
    var pageData   = ${JSON.stringify(k)}
    var messages   = ${JSON.stringify(L)}
  </script>
  <link href="/_editor/style.css" rel="stylesheet" />`;return Q.replace(/<head>/,`<head>${$}`)}function v0(H){L.push(H)}function P0(){return T0}function o(H,Q){e[H]=Q}function N0(H,Q,$){if(k[H]??={},Q!==void 0)k[H][Q]=$;else k[H]=$}function E0(H,Q){return Q!==void 0?I[H]?.[Q]:I[H]}function D0(){return I.pageSettings}async function u0({component:H,data:Q,editorData:$,url:Y}){let{templateToLoad:B,dataToLoad:_}=await t(Y),{dataToSave:X,isSharedData:J,target:W}=await j0(_,Q,H,$);await J0(W,X),L.length=0;let G=J?X:await T(W),K=J?await T(_):X;I=C(K,G);let{template:V}=await import(B),A=await V(),g=new ZH(A).window.document;return{content:f0(g.querySelector("body").innerHTML),pageData:I,messages:L}}var g0={...s(U+"/public","/"),...s(__dirname+"/adminInterface","/_editor")};async function c0(H){return await R(H,{handler:async(Q)=>{let $=new URL(Q.url).pathname;if(!D(!1,!1).includes($))throw new Error("404|page "+$+" not found");return{status:200,body:await y0(M0($),!0),headers:{"Content-Type":"text/html"}}}})}var l0="/api/v1",h0={[l0+"/update-partial"]:{[p.POST]:(H)=>R(H,{handler:async(Q)=>{return{body:await u0(await Q.body),status:200}}})},[l0+"/siteTree"]:(H)=>R(H,{handler:async()=>{return{body:await D(!1,!0),status:200}}})};var m0={},AH={error(H){let[Q,$]=H.message.includes("|")?H.message.split("|"):["500",H.message];return console.error(H.message,{status:Q,msg:$},H.stack),new Response($??H.message,{headers:{"Content-Type":"text/html"},status:parseInt(Q)})},fetch:async(H)=>{return await c0(H)},websocket:{message(){m0.publish("connection","connected")}},port:4001,routes:{...h0,...g0}};function p0(){m0=Bun.serve(AH)}q0({after:[async(H)=>{H.result.headers.set("Cache-Control","no-cache")}]});var u;((Q)=>Q.CHANGE="change")(u||={});var H0;((Q)=>Q.SCSS="scss")(H0||={});var Q0;(($)=>{$.COMPONENTS="components";$.PAGES="pages"})(Q0||={});import*as s0 from"sass";async function Y0(H=!1){let Q={charset:!0,sourceMap:!H,loadPaths:[U+"/css"]};if(H)Q.style="compressed";let $=await s0.compileAsync(U+"/css/style.scss",Q);x(U+"/public/style.css",$.css.toString()),console.log("css generated")}import{watch as MH}from"chokidar";function d0(H,Q,$,Y){let B=MH(H,{persistent:!0});function _(W){for(let G of Q)if(W.endsWith(G))return G;return null}function X(W){for(let G of $)if(W.includes(G)&&!W.endsWith(G))return G;return null}function J(W,G){return _(G)}for(let W of Object.values(u))B.on(W,(G)=>{let K=J(W,G);K!==null&&Y[W][K]()})}function i0(){d0([process.cwd()+"/site"],Object.values(H0),Object.values(Q0),{change:{scss:Y0}})}async function E4(){p0(),await I0(),i0()}var D4={createDirectory:G0,firstLetterLowerCase:U0,firstLetterUppercase:K0,getFolderContent:w,getFolderContentRecursive:F,readFileAsString:W0,writeToFile:x},T4={componentFolder:v,dataExtension:O,index:Z,pageFolder:M,projectRoot:U,templateExtension:q,templateFolder:X0,tsExtension:b};export{D4 as utils,WH as useComponent,E4 as startYajsb,Y0 as makeCss,VH as describeComponent,T4 as constants};
